!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.beta=t():e.beta=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={};function t(e){return e._useProp(void 0)}function r(e,t){return e._useProp(t)}function n(e,t){return e._useProp((()=>Object.assign(Object.assign({},t(e)),{_ctx:e})))._current}function o(e,t){return e._useGPUResource(t)}function c(e,t,r){t._useGPUUpdate(e,r)}function u(e,t){return e._useEffect(t)}(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);var i=1e-6,s="undefined"!=typeof Float32Array?Float32Array:Array;function a(){var e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function d(e,t,r){var n=new s(3);return n[0]=e,n[1]=t,n[2]=r,n}function h(){var e=new s(16);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function f(e,t,r){var n,o,c,u,i,s,a,d,h,f,l,_,p=r[0],v=r[1],m=r[2];return t===e?(e[12]=t[0]*p+t[4]*v+t[8]*m+t[12],e[13]=t[1]*p+t[5]*v+t[9]*m+t[13],e[14]=t[2]*p+t[6]*v+t[10]*m+t[14],e[15]=t[3]*p+t[7]*v+t[11]*m+t[15]):(n=t[0],o=t[1],c=t[2],u=t[3],i=t[4],s=t[5],a=t[6],d=t[7],h=t[8],f=t[9],l=t[10],_=t[11],e[0]=n,e[1]=o,e[2]=c,e[3]=u,e[4]=i,e[5]=s,e[6]=a,e[7]=d,e[8]=h,e[9]=f,e[10]=l,e[11]=_,e[12]=n*p+i*v+h*m+t[12],e[13]=o*p+s*v+f*m+t[13],e[14]=c*p+a*v+l*m+t[14],e[15]=u*p+d*v+_*m+t[15]),e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),a();function l(e){const t=r(e,d(0,0,0)),n=r(e,{distance:5,latitudeRadians:0,longitudeRadians:0}),u=o(e,(e=>e.device.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})));return c([u],e,(e=>{const r=60*Math.PI/180,o=h();!function(e,t,r,n,o){var c,u=1/Math.tan(t/2);e[0]=u/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=o&&o!==1/0?(c=1/(n-o),e[10]=(o+n)*c,e[14]=2*o*n*c):(e[10]=-1,e[14]=-2*n)}(o,r,1,1,2e3);const c=h();var s,l,_,p,v,m,g,x,b,y,A,P,N;f(c,c,t.current),s=c,l=c,_=n.current.longitudeRadians,p=Math.sin(_),v=Math.cos(_),m=l[0],g=l[1],x=l[2],b=l[3],y=l[8],A=l[9],P=l[10],N=l[11],l!==s&&(s[4]=l[4],s[5]=l[5],s[6]=l[6],s[7]=l[7],s[12]=l[12],s[13]=l[13],s[14]=l[14],s[15]=l[15]),s[0]=m*v-y*p,s[1]=g*v-A*p,s[2]=x*v-P*p,s[3]=b*v-N*p,s[8]=m*p+y*v,s[9]=g*p+A*v,s[10]=x*p+P*v,s[11]=b*p+N*v,function(e,t,r){var n=Math.sin(r),o=Math.cos(r),c=t[4],u=t[5],i=t[6],s=t[7],a=t[8],d=t[9],h=t[10],f=t[11];t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=c*o+a*n,e[5]=u*o+d*n,e[6]=i*o+h*n,e[7]=s*o+f*n,e[8]=a*o-c*n,e[9]=d*o-u*n,e[10]=h*o-i*n,e[11]=f*o-s*n}(c,c,n.current.latitudeRadians),f(c,c,d(0,0,n.current.distance));const w=a();!function(e,t){e[0]=t[12],e[1]=t[13],e[2]=t[14]}(w,c);const S=d(0,1,0),U=h();!function(e,t,r,n){var o,c,u,s,a,d,h,f,l,_,p=t[0],v=t[1],m=t[2],g=n[0],x=n[1],b=n[2],y=r[0],A=r[1],P=r[2];Math.abs(p-y)<i&&Math.abs(v-A)<i&&Math.abs(m-P)<i?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(h=p-y,f=v-A,l=m-P,o=x*(l*=_=1/Math.hypot(h,f,l))-b*(f*=_),c=b*(h*=_)-g*l,u=g*f-x*h,(_=Math.hypot(o,c,u))?(o*=_=1/_,c*=_,u*=_):(o=0,c=0,u=0),s=f*u-l*c,a=l*o-h*u,d=h*c-f*o,(_=Math.hypot(s,a,d))?(s*=_=1/_,a*=_,d*=_):(s=0,a=0,d=0),e[0]=o,e[1]=s,e[2]=h,e[3]=0,e[4]=c,e[5]=a,e[6]=f,e[7]=0,e[8]=u,e[9]=d,e[10]=l,e[11]=0,e[12]=-(o*p+c*v+u*m),e[13]=-(s*p+a*v+d*m),e[14]=-(h*p+f*v+l*m),e[15]=1)}(U,w,t.current,S);const E=h();!function(e,t,r){var n=t[0],o=t[1],c=t[2],u=t[3],i=t[4],s=t[5],a=t[6],d=t[7],h=t[8],f=t[9],l=t[10],_=t[11],p=t[12],v=t[13],m=t[14],g=t[15],x=r[0],b=r[1],y=r[2],A=r[3];e[0]=x*n+b*i+y*h+A*p,e[1]=x*o+b*s+y*f+A*v,e[2]=x*c+b*a+y*l+A*m,e[3]=x*u+b*d+y*_+A*g,x=r[4],b=r[5],y=r[6],A=r[7],e[4]=x*n+b*i+y*h+A*p,e[5]=x*o+b*s+y*f+A*v,e[6]=x*c+b*a+y*l+A*m,e[7]=x*u+b*d+y*_+A*g,x=r[8],b=r[9],y=r[10],A=r[11],e[8]=x*n+b*i+y*h+A*p,e[9]=x*o+b*s+y*f+A*v,e[10]=x*c+b*a+y*l+A*m,e[11]=x*u+b*d+y*_+A*g,x=r[12],b=r[13],y=r[14],A=r[15],e[12]=x*n+b*i+y*h+A*p,e[13]=x*o+b*s+y*f+A*v,e[14]=x*c+b*a+y*l+A*m,e[15]=x*u+b*d+y*_+A*g}(E,o,U);const O=E;e.device.queue.writeBuffer(u.current,0,O,0,O.length)})),{targetPosition:t,cameraPosition:n,cameraSourceAsGPUBuffer:u}}function _(e){const r=l(e),n=t(e);return u(e,(e=>{const t=n.current;if(!t)return()=>{};const o=Math.PI/2-.05;var c=0,u=0;const i=e=>{const t=e.clientX-c,n=e.clientY-u;if(c=e.clientX,u=e.clientY,e.altKey){const e=r.cameraPosition.current.longitudeRadians,o=r.cameraPosition.current.latitudeRadians,c=.02,u=c*n*Math.cos(o),i=c*(t*-Math.cos(e)+n*Math.sin(o)*Math.sin(e)),s=c*(t*Math.sin(e)+n*Math.sin(o)*Math.cos(e));r.targetPosition.mutate((e=>{e[0]+=i,e[1]+=u,e[2]+=s}))}else r.cameraPosition.mutate((e=>{e.longitudeRadians-=.01*t,e.latitudeRadians=Math.min(o,Math.max(-o,e.latitudeRadians-.01*n))}))},s=e=>{t.style.cursor="grabbing",c=e.clientX,u=e.clientY,t.addEventListener("pointermove",i),t.setPointerCapture(e.pointerId)},a=e=>{t.style.cursor="grab",t.removeEventListener("pointermove",i)};return t.style.cursor="grab",t.addEventListener("pointerdown",s),t.addEventListener("pointerup",a),()=>{t.style.cursor="auto",t.removeEventListener("pointerdown",s),t.removeEventListener("pointerup",a),t.removeEventListener("pointermove",i)}})),Object.assign(r,{canvas:n})}class p{constructor(e){this._renders=[],this._canvasContext=e}addRender(e){this._renders.includes(e)||this._renders.push(e)}outputFrame(e){const t=this._canvasContext.getCurrentTexture();this._renders.forEach((r=>{r.renderTarget.setAndNotify(t),r.runFrame(e,[r.renderTarget])}))}}function v(e){const r=t(e),n=t(e),u=t(e),i=t(e),s=o(e,(e=>e.device.createShaderModule({code:"@group(0) @binding(0) var<uniform> use_matrix: mat4x4<f32>;\n@group(0) @binding(1) var use_sampler: sampler;\n@group(0) @binding(2) var use_texture: texture_2d<f32>;\n\nstruct VertexOutput {\n  @builtin(position) pos: vec4<f32>;\n  @location(0) uv: vec2<f32>;\n}\n\n@stage(vertex)\nfn vertexRenderUV(\n  @location(0) pos_in: vec4<f32>,\n  @location(1) uv_in: vec2<f32>,\n) ->\n  VertexOutput\n{\n  var out: VertexOutput;\n  out.pos = pos_in;\n  out.uv = uv_in;\n  return out;\n}\n\n@stage(vertex)\nfn vertexRenderUVWithMatrix(\n  @location(0) pos_in: vec4<f32>,\n  @location(1) uv_in: vec2<f32>,\n) ->\n  VertexOutput\n{\n  var out: VertexOutput;\n  out.pos = use_matrix * pos_in;\n  out.uv = uv_in;\n  return out;\n}\n\n@stage(fragment)\nfn fragmentRenderUV(\n  @location(0) uv_in : vec2<f32>\n) ->\n  @location(0) vec4<f32>\n{\n  return textureSample(use_texture, use_sampler, uv_in.xy);\n}\n"}))),a=o(e,(e=>{var t;if(n.current)return e.device.createRenderPipeline({vertex:{module:s.current,entryPoint:(null===(t=r.current)||void 0===t?void 0:t.cameraSourceAsGPUBuffer)?"vertexRenderUVWithMatrix":"vertexRenderUV",buffers:[{arrayStride:n.current.vertexSourceStrideBytes,attributes:[{shaderLocation:0,offset:n.current.vertexSourceXYZWOffsetBytes,format:"float32x4"},{shaderLocation:1,offset:n.current.vertexSourceUVOffsetBytes,format:"float32x2"}]}]},fragment:{module:s.current,entryPoint:"fragmentRenderUV",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},layout:void 0})})),d=o(e,(e=>e.device.createSampler({magFilter:"linear",minFilter:"linear"}))),h=o(e,(e=>{var t,n,o,c;if(!a.current)return;if(!(null===(t=u.current)||void 0===t?void 0:t.textureSourceAsGPUTexture.current))return;const i=[{binding:1,resource:d.current},{binding:2,resource:null===(n=u.current)||void 0===n?void 0:n.textureSourceAsGPUTexture.current.createView()}];return(null===(o=r.current)||void 0===o?void 0:o.cameraSourceAsGPUBuffer)&&i.unshift({binding:0,resource:{buffer:null===(c=r.current)||void 0===c?void 0:c.cameraSourceAsGPUBuffer.current}}),e.device.createBindGroup({layout:a.current.getBindGroupLayout(0),entries:i})})),f=o(e,(e=>e.device.createTexture({size:[300,300],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})));return c([i],e,(e=>{if(!n.current)return;if(!i.current)return;if(!a.current)return;if(!h.current)return;const t=e.commandEncoder.beginRenderPass({colorAttachments:[{view:i.current.createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:f.current.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});t.setPipeline(a.current),t.setVertexBuffer(0,n.current.vertexSourceAsGPUBuffer.current),t.setBindGroup(0,h.current),t.draw(n.current.vertexSourceCount,1,0,0),t.end()})),{cameraSource:r,textureSource:u,vertexSource:n,renderTarget:i}}function m(e){const{imageBitmap:r,label:n,textureSourceAsGPUTexture:i}=function(e){const r=t(e),n=t(e),u=o(e,(e=>{if(r.current)return e.device.createTexture({label:n.current,size:[r.current.width,r.current.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})}));return c([u],e,(e=>{r.current&&u.current&&e.device.queue.copyExternalImageToTexture({source:r.current},{texture:u.current},[r.current.width,r.current.height])})),{imageBitmap:r,label:n,textureSourceAsGPUTexture:u}}(e),s=n;return u(e,(e=>{const t=s.current;if(console.log({currentURL:t}),!t)return()=>{};var n=!1;const o=document.createElement("img");return o.src=t,o.decode().then((()=>n?void 0:createImageBitmap(o))).then((e=>{!n&&e&&r.set(e)})).catch(console.error),()=>{n=!0}})),{url:s,textureSourceAsGPUTexture:i}}function g(e){const t=o(e,(e=>e.device.createBuffer({size:1440,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})));return c([t],e,(e=>{if(!t.current)return;const r=(1+Math.sqrt(5))/2,n=new Float32Array([r,1,0,1,1,0,0,r,1,1,1,1,1,0,r,1,0,1,r,1,0,1,1,0,1,0,r,1,1,1,r,-1,0,1,0,1,r,1,0,1,1,0,r,-1,0,1,1,1,1,0,-r,1,0,1,r,1,0,1,1,0,1,0,-r,1,1,1,0,r,-1,1,0,1,r,1,0,1,1,0,0,r,-1,1,1,1,0,r,1,1,0,1,-1,0,r,1,1,0,1,0,r,1,1,1,0,r,1,1,0,1,0,-r,1,1,1,0,r,-1,0,1,1,1,1,0,r,1,0,1,0,-r,-1,1,1,0,1,0,-r,1,1,1,r,-1,0,1,0,1,-1,0,-r,1,1,0,0,r,-1,1,1,1,1,0,-r,1,0,1,-r,1,0,1,1,0,0,r,1,1,1,1,0,r,-1,1,0,1,1,0,r,1,1,0,-1,0,r,1,1,1,0,-r,1,1,0,1,r,-1,0,1,1,0,0,-r,1,1,1,1,0,-r,-1,1,0,1,1,0,-r,1,1,0,0,-r,-1,1,1,1,-1,0,-r,1,0,1,0,r,-1,1,1,0,-1,0,-r,1,1,1,-r,1,0,1,0,1,0,r,1,1,1,0,-r,1,0,1,1,1,-1,0,r,1,0,1,-r,-1,0,1,1,0,0,-r,1,1,1,1,-1,0,r,1,0,1,-r,-1,0,1,1,0,0,-r,-1,1,1,1,0,-r,1,1,0,1,-r,-1,0,1,1,0,-1,0,-r,1,1,1,0,-r,-1,1,0,1,-r,-1,0,1,1,0,-r,1,0,1,1,1,-1,0,-r,1,0,1,-r,-1,0,1,1,0,-1,0,r,1,1,1,-r,1,0,1,0,1]);e.device.queue.writeBuffer(t.current,0,n,0,n.length)})),{vertexSourceCount:60,vertexSourceTotalBytes:1440,vertexSourceStrideBytes:24,vertexSourceXYZWOffsetBytes:0,vertexSourceUVOffsetBytes:16,vertexSourceAsGPUBuffer:t}}class x{constructor(e,t){this._changeAtNextTick=!1,this._changedClockNumber=0,this._producedClockNumber=0,this._producerOperations=[],this._current=e,this._next=e,this._ctx=t}_attachProducerOperation(e){this._producerOperations.push(e)}_runIfNeededAt(e){return this._changeAtNextTick?(this._current=this._next,this._changeAtNextTick=!1,this._changedClockNumber=e,!0):this._changedClockNumber>=e}_produceIfNeededAt(e){this._producedClockNumber>=e||(this._producerOperations.forEach((t=>t._produceIfNeededAt(e))),this._producedClockNumber=e)}get current(){const e=this._ctx._currentAction;if(!e)throw new Error("It's only possible to read properties from within a reactive context");return e._attachDependency(this),this._current}get readOnly(){return this}set(e){this._current!==e&&this.setAndNotify(e)}setAndNotify(e){this._next=e,this.notify()}change(e){this.set(e(this._current))}mutate(e){e(this._current),this.notify()}notify(){this._changeAtNextTick=!0}}class b{constructor(e,t){this._deps=new Set,this._cachedClockNumber=0,this._producedClockNumber=0,this._producerOperations=[],this._ctx=e,this._fn=t}_attachDependency(e){this._deps.add(e)}_attachProducerOperation(e){this._producerOperations.push(e)}_runIfNeededAt(e){if(this._cachedClockNumber>=e)return!0;var t=!1;if(this._deps.forEach((r=>{r._runIfNeededAt(e)&&(t=!0)})),!t&&this._cachedClockNumber>0)return!1;const r=this._ctx._currentAction;this._ctx._currentAction=this;const n=this._cachedResult;return"object"==typeof n&&"destroy"in n&&"function"==typeof n.destroy&&n.destroy(),this._cachedResult=this._fn(this._ctx),this._cachedClockNumber=e,this._ctx._currentAction=r,!0}_produceIfNeededAt(e){this._producedClockNumber>=e||(this._producerOperations.forEach((t=>t._produceIfNeededAt(e))),this._producedClockNumber=e)}get current(){const e=this._ctx._currentAction;if(!e)throw new Error("It's only possible to read properties from within a reactive context");return e._attachDependency(this),this._runIfNeededAt(this._ctx._currentClockNumber),this._cachedResult}}class y{constructor(e,t){this._deps=new Set,this._producedClockNumber=0,this._ctx=e,this._fn=t}_attachDependency(e){this._deps.add(e)}_produceIfNeededAt(e){if(this._producedClockNumber>=e)return;this._producedClockNumber=e,this._deps.forEach((t=>t._runIfNeededAt(e))),this._deps.forEach((t=>t._produceIfNeededAt(e)));const t=this._ctx._currentAction;this._ctx._currentAction=this,this._fn(this._ctx),this._ctx._currentAction=t}}class A{constructor(e,t){this._deps=new Set,this._lastClockNumber=0,this._ctx=e,this._fn=t}_attachDependency(e){this._deps.add(e)}_runIfNeededAt(e){if(this._lastClockNumber>=e)return!0;var t=!1;if(this._deps.forEach((r=>{r._runIfNeededAt(e)&&(t=!0)})),!t&&this._lastClockNumber>0)return!1;const r=this._lastCancelFn;r&&r();const n=this._ctx._currentAction;this._ctx._currentAction=this,this._lastCancelFn=this._fn(this._ctx),this._ctx._currentAction=n,this._lastClockNumber=e}}class P{constructor(e){this._currentClockNumber=1,this._effects=[],this._device=e}get commandEncoder(){return this._commandEncoder}get device(){return this._device}_useProp(e){return new x("function"==typeof e?e():e,this)}_useGPUResource(e){return new b(this,e)}_useGPUUpdate(e,t){const r=new y(this,t);e.forEach((e=>e._attachProducerOperation(r)))}_useEffect(e){this._effects.push(new A(this,e))}}var N=function(e,t,r,n){return new(r||(r=Promise))((function(o,c){function u(e){try{s(n.next(e))}catch(e){c(e)}}function i(e){try{s(n.throw(e))}catch(e){c(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,i)}s((n=n.apply(e,t||[])).next())}))};function w(){const e=document.querySelector("canvas.main");if(!e)throw new Error("The main canvas wasn't found in the HTML!");return e}function S(){var e,t;const r=null===(t=null===(e=navigator.gpu)||void 0===e?void 0:e.getPreferredCanvasFormat)||void 0===t?void 0:t.bind(navigator.gpu);return r?r():"rgba8unorm"}var U;return U=e=>{const t=n(e,_),r=n(e,g),o=n(e,m);o.url.set("./assets/fireweed.jpg"),t.canvas.set(w());const c=n(e,v),{renderTarget:u}=c,i=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}(c,["renderTarget"]);return i.cameraSource.set(t),i.textureSource.set(o),i.vertexSource.set(r),{renderTarget:u}},function(e){(()=>N(this,void 0,void 0,(function*(){const e=yield function(e="high-performance"){return N(this,void 0,void 0,(function*(){if(!navigator.gpu)throw new Error("Your browser doesn't have WebGPU enabled!");const t=yield navigator.gpu.requestAdapter({powerPreference:e});if(!t)throw new Error("Failed to get the GPU adapter!");return t.requestDevice()}))}(),t=yield function(e,t){return N(this,void 0,void 0,(function*(){const r=e.getContext("webgpu");if(!r)throw new Error("Failed to get a WebGPU canvas context!");return r.configure({device:t,format:S(),alphaMode:"opaque"}),r}))}(w(),e),r=((e,t)=>{const r=function(e,t){const r=new P(e),n=Object.assign(Object.assign({},t(r)),{_ctx:r});return n.runFrame=(e,t)=>{r._currentClockNumber+=1,r._commandEncoder=e;const n=r._currentClockNumber;t.forEach((e=>e._produceIfNeededAt(n))),r._effects.forEach((e=>e._runIfNeededAt(n))),r._commandEncoder=void 0},n}(e,U),n=new p(t);return n.addRender(r),function(e){n.outputFrame(e)}})(e,t);requestAnimationFrame((function t(){!function(e,t){const r=e.createCommandEncoder();t(r),e.queue.submit([r.finish()])}(e,r),requestAnimationFrame(t)}))})))().catch((e=>{document.querySelector("body").innerHTML=e,console.error(e)}))}(),e})()));
//# sourceMappingURL=demo4.js.map