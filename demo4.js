!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.beta=t():e.beta=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);class t{constructor(e,t){this._current=e,this._ctx=t}get current(){return this._current}set(e){this._current!==e&&(this._current=e,this._ctx._needsUnitReRun=!0)}change(e){const t=e(this._current);this._current!==t&&(this._current=t,this._ctx._needsUnitReRun=!0)}mutate(e){e(this._current),this._ctx._needsUnitReRun=!0}}class n{constructor(e,t){this._store=[],this._storeIndex=0,this._storeUnits=[],this._storeUnitsIndex=0,this._storeGPUActions=[],this._storeGPUActionsIndex=0,this._needsUnitReRun=!0,this._unitFn=e,this.device=t}_nextStoreIndex(){const e=this._storeIndex;return this._storeIndex=e+1,e}_nextStoreUnitsIndex(){const e=this._storeUnitsIndex;return this._storeUnitsIndex=e+1,e}_nextStoreGPUActionsIndex(){const e=this._storeGPUActionsIndex;return this._storeGPUActionsIndex=e+1,e}runUnitIfNeeded(e){var t=!1;return this._storeUnits.forEach((e=>{const n=e.current;(null==n?void 0:n._ctx.runUnitIfNeeded(n))&&(t=!0)})),!(!this._needsUnitReRun&&!t||(this._storeIndex=0,this._storeUnitsIndex=0,this._storeGPUActionsIndex=0,this._needsUnitReRun=!1,Object.assign(e,this._unitFn(this)),0))}runGPUActionsIfNeeded(e){this._storeUnits.forEach((t=>{const n=t.current;null==n||n._ctx.runGPUActionsIfNeeded(e)})),this.commandEncoder=e,this._storeGPUActions.forEach((([e,t,n],r)=>{n&&(e(this),this._storeGPUActions[r][2]=!1)})),this.commandEncoder=void 0}_useProp(e){const n=this._nextStoreIndex(),r=this._store[n];if(r)return r;const o=new t("function"==typeof e?e():e,this);return this._store[n]=o,o}_useUnitProp(e){const n=this._nextStoreUnitsIndex(),r=this._storeUnits[n];if(r)return r;const o=new t("function"==typeof e?e():e,this);return this._storeUnits[n]=o,o}_useGPUResource(e,t){const n=this._nextStoreIndex(),r=this._store[n];if(!r){const r=e(this);return this._store[n]=[r,t],r}if(t.every(((e,t)=>e===r[1][t])))return r[0];const o=e(this),i=r[0];return r[0]=o,r[1]=t,i&&"function"==typeof i.destroy&&i.destroy(),o}_useGPUAction(e,t){const n=this._nextStoreGPUActionsIndex(),r=this._storeGPUActions[n];r?t.every(((e,t)=>e===r[1][t]))||(r[0]=e,r[1]=t,r[2]=!0):this._storeGPUActions[n]=[e,t,!0]}_useEffect(e,t){const n=this._nextStoreIndex(),r=this._store[n];if(r)t.every(((e,t)=>e===r[1][t]))||(r[0]&&r[0](),r[0]=e({}),r[1]=t);else{const r=e({});this._store[n]=[r,t]}}}function r(e){return e._useProp(void 0)}function o(e,t){return e._useProp(t)}function i(e){return e._useUnitProp(void 0)}function s(e,t){return e._useUnitProp((()=>function(e,t){const r=new n(t,e);return Object.assign(Object.assign({},t(r)),{_ctx:r})}(e.device,t))).current}function u(e,t,n){return e._useGPUResource(t,n)}function c(e,t,n){e._useGPUAction(t,n)}var a=1e-6,d="undefined"!=typeof Float32Array?Float32Array:Array;function f(){var e=new d(3);return d!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function h(e,t,n){var r=new d(3);return r[0]=e,r[1]=t,r[2]=n,r}function l(){var e=new d(16);return d!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function v(e,t,n){var r,o,i,s,u,c,a,d,f,h,l,v,p=n[0],x=n[1],_=n[2];return t===e?(e[12]=t[0]*p+t[4]*x+t[8]*_+t[12],e[13]=t[1]*p+t[5]*x+t[9]*_+t[13],e[14]=t[2]*p+t[6]*x+t[10]*_+t[14],e[15]=t[3]*p+t[7]*x+t[11]*_+t[15]):(r=t[0],o=t[1],i=t[2],s=t[3],u=t[4],c=t[5],a=t[6],d=t[7],f=t[8],h=t[9],l=t[10],v=t[11],e[0]=r,e[1]=o,e[2]=i,e[3]=s,e[4]=u,e[5]=c,e[6]=a,e[7]=d,e[8]=f,e[9]=h,e[10]=l,e[11]=v,e[12]=r*p+u*x+f*_+t[12],e[13]=o*p+c*x+h*_+t[13],e[14]=i*p+a*x+l*_+t[14],e[15]=s*p+d*x+v*_+t[15]),e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),f();function p(e){const t=o(e,h(0,0,0)),n=o(e,{distance:5,latitudeRadians:0,longitudeRadians:0}),r=u(e,(e=>e.device.createBuffer({size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})),[]);return c(e,(e=>{const o=60*Math.PI/180,i=l();!function(e,t,n,r,o){var i,s=1/Math.tan(t/2);e[0]=s/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=o&&o!==1/0?(i=1/(r-o),e[10]=(o+r)*i,e[14]=2*o*r*i):(e[10]=-1,e[14]=-2*r)}(i,o,1,1,2e3);const s=l();var u,c,d,p,x,_,g,m,U,y,P,b,S;v(s,s,t.current),u=s,c=s,d=n.current.longitudeRadians,p=Math.sin(d),x=Math.cos(d),_=c[0],g=c[1],m=c[2],U=c[3],y=c[8],P=c[9],b=c[10],S=c[11],c!==u&&(u[4]=c[4],u[5]=c[5],u[6]=c[6],u[7]=c[7],u[12]=c[12],u[13]=c[13],u[14]=c[14],u[15]=c[15]),u[0]=_*x-y*p,u[1]=g*x-P*p,u[2]=m*x-b*p,u[3]=U*x-S*p,u[8]=_*p+y*x,u[9]=g*p+P*x,u[10]=m*p+b*x,u[11]=U*p+S*x,function(e,t,n){var r=Math.sin(n),o=Math.cos(n),i=t[4],s=t[5],u=t[6],c=t[7],a=t[8],d=t[9],f=t[10],h=t[11];t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=i*o+a*r,e[5]=s*o+d*r,e[6]=u*o+f*r,e[7]=c*o+h*r,e[8]=a*o-i*r,e[9]=d*o-s*r,e[10]=f*o-u*r,e[11]=h*o-c*r}(s,s,n.current.latitudeRadians),v(s,s,h(0,0,n.current.distance));const w=f();!function(e,t){e[0]=t[12],e[1]=t[13],e[2]=t[14]}(w,s);const G=h(0,1,0),R=l();!function(e,t,n,r){var o,i,s,u,c,d,f,h,l,v,p=t[0],x=t[1],_=t[2],g=r[0],m=r[1],U=r[2],y=n[0],P=n[1],b=n[2];Math.abs(p-y)<a&&Math.abs(x-P)<a&&Math.abs(_-b)<a?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(f=p-y,h=x-P,l=_-b,o=m*(l*=v=1/Math.hypot(f,h,l))-U*(h*=v),i=U*(f*=v)-g*l,s=g*h-m*f,(v=Math.hypot(o,i,s))?(o*=v=1/v,i*=v,s*=v):(o=0,i=0,s=0),u=h*s-l*i,c=l*o-f*s,d=f*i-h*o,(v=Math.hypot(u,c,d))?(u*=v=1/v,c*=v,d*=v):(u=0,c=0,d=0),e[0]=o,e[1]=u,e[2]=f,e[3]=0,e[4]=i,e[5]=c,e[6]=h,e[7]=0,e[8]=s,e[9]=d,e[10]=l,e[11]=0,e[12]=-(o*p+i*x+s*_),e[13]=-(u*p+c*x+d*_),e[14]=-(f*p+h*x+l*_),e[15]=1)}(R,w,t.current,G);const A=l();!function(e,t,n){var r=t[0],o=t[1],i=t[2],s=t[3],u=t[4],c=t[5],a=t[6],d=t[7],f=t[8],h=t[9],l=t[10],v=t[11],p=t[12],x=t[13],_=t[14],g=t[15],m=n[0],U=n[1],y=n[2],P=n[3];e[0]=m*r+U*u+y*f+P*p,e[1]=m*o+U*c+y*h+P*x,e[2]=m*i+U*a+y*l+P*_,e[3]=m*s+U*d+y*v+P*g,m=n[4],U=n[5],y=n[6],P=n[7],e[4]=m*r+U*u+y*f+P*p,e[5]=m*o+U*c+y*h+P*x,e[6]=m*i+U*a+y*l+P*_,e[7]=m*s+U*d+y*v+P*g,m=n[8],U=n[9],y=n[10],P=n[11],e[8]=m*r+U*u+y*f+P*p,e[9]=m*o+U*c+y*h+P*x,e[10]=m*i+U*a+y*l+P*_,e[11]=m*s+U*d+y*v+P*g,m=n[12],U=n[13],y=n[14],P=n[15],e[12]=m*r+U*u+y*f+P*p,e[13]=m*o+U*c+y*h+P*x,e[14]=m*i+U*a+y*l+P*_,e[15]=m*s+U*d+y*v+P*g}(A,i,R);const M=A;e.device.queue.writeBuffer(r,0,M,0,M.length)}),[r,t.current,n.current]),{targetPosition:t,cameraPosition:n,cameraSourceAsGPUBuffer:r}}function x(e){const t=p(e),n=r(e);return function(e,r,o){e._useEffect((e=>{const r=n.current;if(!r)return()=>{};const o=Math.PI/2-.05;var i=0,s=0;const u=e=>{const n=e.clientX-i,r=e.clientY-s;if(i=e.clientX,s=e.clientY,e.altKey){const e=t.cameraPosition.current.longitudeRadians,o=t.cameraPosition.current.latitudeRadians,i=.02,s=(Math.cos(o),i*(n*-Math.cos(e)+r*Math.sin(o)*Math.sin(e)));Math.sin(e),Math.sin(o),Math.cos(e),t.targetPosition.change((e=>h(e[0]+s,e[1]+s,e[2]+s)))}else t.cameraPosition.change((e=>({distance:e.distance,longitudeRadians:e.longitudeRadians-.01*n,latitudeRadians:Math.min(o,Math.max(-o,e.latitudeRadians-.01*r))})))},c=e=>{r.style.cursor="grabbing",i=e.clientX,s=e.clientY,r.addEventListener("pointermove",u),r.setPointerCapture(e.pointerId)},a=e=>{r.style.cursor="grab",r.removeEventListener("pointermove",u)};return r.style.cursor="grab",r.addEventListener("pointerdown",c),r.addEventListener("pointerup",a),()=>{r.style.cursor="auto",r.removeEventListener("pointerdown",c),r.removeEventListener("pointerup",a),r.removeEventListener("pointermove",u)}}),o)}(e,0,[n.current]),Object.assign(t,{canvas:n})}class _{constructor(e){this._renders=[],this._canvasContext=e}addRender(e){this._renders.includes(e)||this._renders.push(e)}outputFrame(e){const t=this._canvasContext.getCurrentTexture();this._renders.forEach((n=>{n.renderTarget.set(t),n.runFrame(e)}))}}function g(e){var t,n;const o=i(e),s=i(e),a=i(e),d=r(e),f=null===(t=o.current)||void 0===t?void 0:t.cameraSourceAsGPUBuffer,h=null===(n=a.current)||void 0===n?void 0:n.textureSourceAsGPUTexture,l=u(e,(e=>e.device.createShaderModule({code:"@group(0) @binding(0) var<uniform> use_matrix: mat4x4<f32>;\n@group(0) @binding(1) var use_sampler: sampler;\n@group(0) @binding(2) var use_texture: texture_2d<f32>;\n\nstruct VertexOutput {\n  @builtin(position) pos: vec4<f32>;\n  @location(0) uv: vec2<f32>;\n}\n\n@stage(vertex)\nfn vertexRenderUV(\n  @location(0) pos_in: vec4<f32>,\n  @location(1) uv_in: vec2<f32>,\n) ->\n  VertexOutput\n{\n  var out: VertexOutput;\n  out.pos = pos_in;\n  out.uv = uv_in;\n  return out;\n}\n\n@stage(vertex)\nfn vertexRenderUVWithMatrix(\n  @location(0) pos_in: vec4<f32>,\n  @location(1) uv_in: vec2<f32>,\n) ->\n  VertexOutput\n{\n  var out: VertexOutput;\n  out.pos = use_matrix * pos_in;\n  out.uv = uv_in;\n  return out;\n}\n\n@stage(fragment)\nfn fragmentRenderUV(\n  @location(0) uv_in : vec2<f32>\n) ->\n  @location(0) vec4<f32>\n{\n  return textureSample(use_texture, use_sampler, uv_in.xy);\n}\n"})),[]),v=u(e,(e=>{if(s.current)return e.device.createRenderPipeline({vertex:{module:l,entryPoint:f?"vertexRenderUVWithMatrix":"vertexRenderUV",buffers:[{arrayStride:s.current.vertexSourceStrideBytes,attributes:[{shaderLocation:0,offset:s.current.vertexSourceXYZWOffsetBytes,format:"float32x4"},{shaderLocation:1,offset:s.current.vertexSourceUVOffsetBytes,format:"float32x2"}]}]},fragment:{module:l,entryPoint:"fragmentRenderUV",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},layout:void 0})}),[l,s.current]),p=u(e,(e=>e.device.createSampler({magFilter:"linear",minFilter:"linear"})),[]),x=u(e,(e=>{if(!v)return;if(!h)return;const t=[{binding:1,resource:p},{binding:2,resource:h.createView()}];return f&&t.unshift({binding:0,resource:{buffer:f}}),e.device.createBindGroup({layout:v.getBindGroupLayout(0),entries:t})}),[v,f,h,p]),_=u(e,(e=>e.device.createTexture({size:[300,300],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})),[]);return c(e,(e=>{if(!s.current)return;if(!d.current)return;if(!v)return;if(!x)return;const t=e.commandEncoder.beginRenderPass({colorAttachments:[{view:d.current.createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:_.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});t.setPipeline(v),t.setVertexBuffer(0,s.current.vertexSourceAsGPUBuffer),t.setBindGroup(0,x),t.draw(s.current.vertexSourceCount,1,0,0),t.end()}),[s.current,d.current,v,x]),{cameraSource:o,textureSource:a,vertexSource:s,renderTarget:d}}function m(e){const{imageBitmap:t,label:n,textureSourceAsGPUTexture:o}=function(e){var t,n,o,i;const s=r(e),a=r(e),d=null!==(n=null===(t=s.current)||void 0===t?void 0:t.width)&&void 0!==n?n:16,f=null!==(i=null===(o=s.current)||void 0===o?void 0:o.height)&&void 0!==i?i:16,h=u(e,(e=>e.device.createTexture({label:a.current,size:[d,f,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})),[d,f,a.current]);return c(e,(e=>{s.current&&h&&e.device.queue.copyExternalImageToTexture({source:s.current},{texture:h},[s.current.width,s.current.height])}),[s.current,h]),{imageBitmap:s,label:a,textureSourceAsGPUTexture:h}}(e),i=n;return function(e,t,n,r){e._useEffect((e=>{var r=!1;return n().then((e=>r||t(e))).catch((e=>{console.error(e),r=!0})),()=>{r=!0}}),r)}(e,t.set.bind(t),(e=>{return t=this,n=void 0,o=function*(){if(!i.current)return;const e=document.createElement("img");return e.src=i.current,yield e.decode(),yield createImageBitmap(e)},new((r=void 0)||(r=Promise))((function(e,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function u(e){try{c(o.throw(e))}catch(e){i(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(s,u)}c((o=o.apply(t,n||[])).next())}));var t,n,r,o}),[i.current]),{url:i,textureSourceAsGPUTexture:o}}function U(e){const t=u(e,(e=>e.device.createBuffer({size:1440,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})),[]);return c(e,(e=>{if(!t)return;const n=(1+Math.sqrt(5))/2,r=new Float32Array([n,1,0,1,1,0,0,n,1,1,1,1,1,0,n,1,0,1,n,1,0,1,1,0,1,0,n,1,1,1,n,-1,0,1,0,1,n,1,0,1,1,0,n,-1,0,1,1,1,1,0,-n,1,0,1,n,1,0,1,1,0,1,0,-n,1,1,1,0,n,-1,1,0,1,n,1,0,1,1,0,0,n,-1,1,1,1,0,n,1,1,0,1,-1,0,n,1,1,0,1,0,n,1,1,1,0,n,1,1,0,1,0,-n,1,1,1,0,n,-1,0,1,1,1,1,0,n,1,0,1,0,-n,-1,1,1,0,1,0,-n,1,1,1,n,-1,0,1,0,1,-1,0,-n,1,1,0,0,n,-1,1,1,1,1,0,-n,1,0,1,-n,1,0,1,1,0,0,n,1,1,1,1,0,n,-1,1,0,1,1,0,n,1,1,0,-1,0,n,1,1,1,0,-n,1,1,0,1,n,-1,0,1,1,0,0,-n,1,1,1,1,0,-n,-1,1,0,1,1,0,-n,1,1,0,0,-n,-1,1,1,1,-1,0,-n,1,0,1,0,n,-1,1,1,0,-1,0,-n,1,1,1,-n,1,0,1,0,1,0,n,1,1,1,0,-n,1,0,1,1,1,-1,0,n,1,0,1,-n,-1,0,1,1,0,0,-n,1,1,1,1,-1,0,n,1,0,1,-n,-1,0,1,1,0,0,-n,-1,1,1,1,0,-n,1,1,0,1,-n,-1,0,1,1,0,-1,0,-n,1,1,1,0,-n,-1,1,0,1,-n,-1,0,1,1,0,-n,1,0,1,1,1,-1,0,-n,1,0,1,-n,-1,0,1,1,0,-1,0,n,1,1,1,-n,1,0,1,0,1]);e.device.queue.writeBuffer(t,0,r,0,r.length)}),[t]),{vertexSourceCount:60,vertexSourceTotalBytes:1440,vertexSourceStrideBytes:24,vertexSourceXYZWOffsetBytes:0,vertexSourceUVOffsetBytes:16,vertexSourceAsGPUBuffer:t}}var y=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function u(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,u)}c((r=r.apply(e,t||[])).next())}))};function P(){const e=document.querySelector("canvas.main");if(!e)throw new Error("The main canvas wasn't found in the HTML!");return e}function b(){var e,t;const n=null===(t=null===(e=navigator.gpu)||void 0===e?void 0:e.getPreferredCanvasFormat)||void 0===t?void 0:t.bind(navigator.gpu);return n?n():"rgba8unorm"}var S;return S=e=>{const t=s(e,x),n=s(e,U),r=s(e,m);r.url.set("./assets/fireweed.jpg"),t.canvas.set(P());const o=s(e,g),{renderTarget:i}=o,u=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(o,["renderTarget"]);return u.cameraSource.set(t),u.textureSource.set(r),u.vertexSource.set(n),{renderTarget:i}},function(e){(()=>y(this,void 0,void 0,(function*(){const e=yield function(e="high-performance"){return y(this,void 0,void 0,(function*(){if(!navigator.gpu)throw new Error("Your browser doesn't have WebGPU enabled!");const t=yield navigator.gpu.requestAdapter({powerPreference:e});if(!t)throw new Error("Failed to get the GPU adapter!");return t.requestDevice()}))}(),t=yield function(e,t){return y(this,void 0,void 0,(function*(){const n=e.getContext("webgpu");if(!n)throw new Error("Failed to get a WebGPU canvas context!");return n.configure({device:t,format:b(),alphaMode:"opaque"}),n}))}(P(),e),r=((e,t)=>{const r=function(e,t){const r=new n(t,e),o=Object.assign(Object.assign({},t(r)),{_ctx:r});return o.runFrame=e=>function(e,t){const n=e._ctx;n.runUnitIfNeeded(e),n.runGPUActionsIfNeeded(t)}(o,e),o}(e,S),o=new _(t);return o.addRender(r),function(e){o.outputFrame(e)}})(e,t);requestAnimationFrame((function t(){!function(e,t){const n=e.createCommandEncoder();t(n),e.queue.submit([n.finish()])}(e,r),requestAnimationFrame(t)}))})))().catch((e=>{document.querySelector("body").innerHTML=e,console.error(e)}))}(),e})()));
//# sourceMappingURL=demo4.js.map