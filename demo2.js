!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.beta=t():e.beta=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);class t{constructor(e,t){this._current=e,this._ctx=t}get current(){return this._current}get readOnly(){return this}set(e){this._current!==e&&this.setAndNotify(e)}setAndNotify(e){this._current=e,this._ctx._needsUnitReRun=!0}change(e){this.set(e(this._current))}mutate(e){e(this._current),this._ctx._needsUnitReRun=!0}}class r{constructor(e,t){this._store=[],this._storeIndex=0,this._storeUnits=[],this._storeUnitsIndex=0,this._storeGPUActions=[],this._storeGPUActionsIndex=0,this._needsUnitReRun=!0,this._unitFn=e,this.device=t}_nextStoreIndex(){const e=this._storeIndex;return this._storeIndex=e+1,e}_nextStoreUnitsIndex(){const e=this._storeUnitsIndex;return this._storeUnitsIndex=e+1,e}_nextStoreGPUActionsIndex(){const e=this._storeGPUActionsIndex;return this._storeGPUActionsIndex=e+1,e}runUnitIfNeeded(e){var t=!1;return this._storeUnits.forEach((e=>{const r=e.current;(null==r?void 0:r._ctx.runUnitIfNeeded(r))&&(t=!0)})),!(!this._needsUnitReRun&&!t||(this._storeIndex=0,this._storeUnitsIndex=0,this._storeGPUActionsIndex=0,this._needsUnitReRun=!1,Object.assign(e,this._unitFn(this)),0))}runGPUActionsIfNeeded(e){this._storeUnits.forEach((t=>{const r=t.current;null==r||r._ctx.runGPUActionsIfNeeded(e)})),this.commandEncoder=e,this._storeGPUActions.forEach((([e,t,r],n)=>{r&&(e(this),this._storeGPUActions[n][2]=!1)})),this.commandEncoder=void 0}_useProp(e){const r=this._nextStoreIndex(),n=this._store[r];if(n)return n;const o=new t("function"==typeof e?e():e,this);return this._store[r]=o,o}_useUnitProp(e){const r=this._nextStoreUnitsIndex(),n=this._storeUnits[r];if(n)return n;const o=new t("function"==typeof e?e():e,this);return this._storeUnits[r]=o,o}_useGPUResource(e,t){const r=this._nextStoreIndex(),n=this._store[r];if(!n){const n=e(this);return this._store[r]=[n,t],n}if(t.every(((e,t)=>e===n[1][t])))return n[0];const o=e(this),i=n[0];return n[0]=o,n[1]=t,i&&"function"==typeof i.destroy&&i.destroy(),o}_useGPUAction(e,t){const r=this._nextStoreGPUActionsIndex(),n=this._storeGPUActions[r];n?t.every(((e,t)=>e===n[1][t]))||(n[0]=e,n[1]=t,n[2]=!0):this._storeGPUActions[r]=[e,t,!0]}_useEffect(e,t){const r=this._nextStoreIndex(),n=this._store[r];if(n)t.every(((e,t)=>e===n[1][t]))||(n[0]&&n[0](),n[0]=e({}),n[1]=t);else{const n=e({});this._store[r]=[n,t]}}}function n(e){return e._useProp(void 0)}function o(e){return e._useUnitProp(void 0)}function i(e,t){return e._useUnitProp((()=>function(e,t){const n=new r(t,e);return Object.assign(Object.assign({},t(n)),{_ctx:n})}(e.device,t))).current}function u(e,t,r){return e._useGPUResource(t,r)}function s(e,t,r){e._useGPUAction(t,r)}class c{constructor(e){this._renders=[],this._canvasContext=e}addRender(e){this._renders.includes(e)||this._renders.push(e)}outputFrame(e){const t=this._canvasContext.getCurrentTexture();this._renders.forEach((r=>{r.renderTarget.set(t),r.runFrame(e)}))}}function a(e){const t=n(e),r=u(e,(e=>e.device.createBuffer({size:144,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST})),[]);return s(e,(e=>{if(!r)return;var n=0,o=1,i=0,u=1;t.current&&(t.current<1?u=1-(i=.5-.5*t.current):o=1-(n=.5-.5/t.current));const s=new Float32Array([1,1,0,1,o,i,-1,-1,0,1,n,u,-1,1,0,1,n,i,1,1,0,1,o,i,1,-1,0,1,o,u,-1,-1,0,1,n,u]);e.device.queue.writeBuffer(r,0,s,0,s.length)}),[r,t.current]),{aspectFillRatio:t,vertexSourceCount:6,vertexSourceTotalBytes:144,vertexSourceStrideBytes:24,vertexSourceXYZWOffsetBytes:0,vertexSourceUVOffsetBytes:16,vertexSourceAsGPUBuffer:r}}function d(e){const{textureSource:t,vertexSource:r,renderTarget:c}=function(e){var t,r;const i=o(e),c=o(e),a=o(e),d=n(e),f=null===(t=i.current)||void 0===t?void 0:t.cameraSourceAsGPUBuffer,h=null===(r=a.current)||void 0===r?void 0:r.textureSourceAsGPUTexture,l=u(e,(e=>e.device.createShaderModule({code:"@group(0) @binding(0) var<uniform> use_matrix: mat4x4<f32>;\n@group(0) @binding(1) var use_sampler: sampler;\n@group(0) @binding(2) var use_texture: texture_2d<f32>;\n\nstruct VertexOutput {\n  @builtin(position) pos: vec4<f32>;\n  @location(0) uv: vec2<f32>;\n}\n\n@stage(vertex)\nfn vertexRenderUV(\n  @location(0) pos_in: vec4<f32>,\n  @location(1) uv_in: vec2<f32>,\n) ->\n  VertexOutput\n{\n  var out: VertexOutput;\n  out.pos = pos_in;\n  out.uv = uv_in;\n  return out;\n}\n\n@stage(vertex)\nfn vertexRenderUVWithMatrix(\n  @location(0) pos_in: vec4<f32>,\n  @location(1) uv_in: vec2<f32>,\n) ->\n  VertexOutput\n{\n  var out: VertexOutput;\n  out.pos = use_matrix * pos_in;\n  out.uv = uv_in;\n  return out;\n}\n\n@stage(fragment)\nfn fragmentRenderUV(\n  @location(0) uv_in : vec2<f32>\n) ->\n  @location(0) vec4<f32>\n{\n  return textureSample(use_texture, use_sampler, uv_in.xy);\n}\n"})),[]),v=u(e,(e=>{if(c.current)return e.device.createRenderPipeline({vertex:{module:l,entryPoint:f?"vertexRenderUVWithMatrix":"vertexRenderUV",buffers:[{arrayStride:c.current.vertexSourceStrideBytes,attributes:[{shaderLocation:0,offset:c.current.vertexSourceXYZWOffsetBytes,format:"float32x4"},{shaderLocation:1,offset:c.current.vertexSourceUVOffsetBytes,format:"float32x2"}]}]},fragment:{module:l,entryPoint:"fragmentRenderUV",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},layout:void 0})}),[l,c.current]),x=u(e,(e=>e.device.createSampler({magFilter:"linear",minFilter:"linear"})),[]),p=u(e,(e=>{if(!v)return;if(!h)return;const t=[{binding:1,resource:x},{binding:2,resource:h.createView()}];return f&&t.unshift({binding:0,resource:{buffer:f}}),e.device.createBindGroup({layout:v.getBindGroupLayout(0),entries:t})}),[v,f,h,x]),_=u(e,(e=>e.device.createTexture({size:[300,300],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})),[]);return s(e,(e=>{if(!c.current)return;if(!d.current)return;if(!v)return;if(!p)return;const t=e.commandEncoder.beginRenderPass({colorAttachments:[{view:d.current.createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:_.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});t.setPipeline(v),t.setVertexBuffer(0,c.current.vertexSourceAsGPUBuffer),t.setBindGroup(0,p),t.draw(c.current.vertexSourceCount,1,0,0),t.end()}),[c.current,d.current,v,p]),{cameraSource:i,textureSource:a,vertexSource:c,renderTarget:d}}(e),d=i(e,a);return r.set(d),d.aspectFillRatio.set(850/1275),{textureSource:t,renderTarget:c}}function f(e){const{imageBitmap:t,label:r,textureSourceAsGPUTexture:o}=function(e){var t,r,o,i;const c=n(e),a=n(e),d=null!==(r=null===(t=c.current)||void 0===t?void 0:t.width)&&void 0!==r?r:16,f=null!==(i=null===(o=c.current)||void 0===o?void 0:o.height)&&void 0!==i?i:16,h=u(e,(e=>e.device.createTexture({label:a.current,size:[d,f,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT})),[d,f,a.current]);return s(e,(e=>{c.current&&h&&e.device.queue.copyExternalImageToTexture({source:c.current},{texture:h},[c.current.width,c.current.height])}),[c.current,h]),{imageBitmap:c,label:a,textureSourceAsGPUTexture:h}}(e),i=r;return function(e,t,r,n){e._useEffect((e=>{var n=!1;return r().then((e=>n||t(e))).catch((e=>{console.error(e),n=!0})),()=>{n=!0}}),n)}(e,t.set.bind(t),(e=>{return t=this,r=void 0,o=function*(){if(!i.current)return;const e=document.createElement("img");return e.src=i.current,yield e.decode(),yield createImageBitmap(e)},new((n=void 0)||(n=Promise))((function(e,i){function u(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(t){var r;t.done?e(t.value):(r=t.value,r instanceof n?r:new n((function(e){e(r)}))).then(u,s)}c((o=o.apply(t,r||[])).next())}));var t,r,n,o}),[i.current]),{url:i,textureSourceAsGPUTexture:o}}var h=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function u(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(u,s)}c((n=n.apply(e,t||[])).next())}))};function l(){var e,t;const r=null===(t=null===(e=navigator.gpu)||void 0===e?void 0:e.getPreferredCanvasFormat)||void 0===t?void 0:t.bind(navigator.gpu);return r?r():"rgba8unorm"}var v;return v=e=>{const t=i(e,f);t.url.set("./assets/fireweed.jpg");const r=i(e,d),{renderTarget:n}=r;return function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}(r,["renderTarget"]).textureSource.set(t),{renderTarget:n}},function(e){(()=>h(this,void 0,void 0,(function*(){const e=yield function(e="high-performance"){return h(this,void 0,void 0,(function*(){if(!navigator.gpu)throw new Error("Your browser doesn't have WebGPU enabled!");const t=yield navigator.gpu.requestAdapter({powerPreference:e});if(!t)throw new Error("Failed to get the GPU adapter!");return t.requestDevice()}))}(),t=yield function(e,t){return h(this,void 0,void 0,(function*(){const r=e.getContext("webgpu");if(!r)throw new Error("Failed to get a WebGPU canvas context!");return r.configure({device:t,format:l(),alphaMode:"opaque"}),r}))}(function(){const e=document.querySelector("canvas.main");if(!e)throw new Error("The main canvas wasn't found in the HTML!");return e}(),e),n=((e,t)=>{const n=function(e,t){const n=new r(t,e),o=Object.assign(Object.assign({},t(n)),{_ctx:n});return o.runFrame=e=>function(e,t){const r=e._ctx;r.runUnitIfNeeded(e),r.runGPUActionsIfNeeded(t)}(o,e),o}(e,v),o=new c(t);return o.addRender(n),function(e){o.outputFrame(e)}})(e,t);requestAnimationFrame((function t(){!function(e,t){const r=e.createCommandEncoder();t(r),e.queue.submit([r.finish()])}(e,n),requestAnimationFrame(t)}))})))().catch((e=>{document.querySelector("body").innerHTML=e,console.error(e)}))}(),e})()));
//# sourceMappingURL=demo2.js.map