!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.beta=t():e.beta=t()}("undefined"!=typeof self?self:this,(()=>(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);class t{constructor(e,t){this._current=e,this._ctx=t}get current(){return this._current}get readOnly(){return this}set(e){this._current!==e&&this.setAndNotify(e)}setAndNotify(e){this._current=e,this._ctx._needsUnitReRun=!0}change(e){this.set(e(this._current))}mutate(e){e(this._current),this._ctx._needsUnitReRun=!0}}class n{constructor(e,t){this._store=[],this._storeIndex=0,this._storeUnits=[],this._storeUnitsIndex=0,this._storeGPUActions=[],this._storeGPUActionsIndex=0,this._needsUnitReRun=!0,this._unitFn=e,this.device=t}_nextStoreIndex(){const e=this._storeIndex;return this._storeIndex=e+1,e}_nextStoreUnitsIndex(){const e=this._storeUnitsIndex;return this._storeUnitsIndex=e+1,e}_nextStoreGPUActionsIndex(){const e=this._storeGPUActionsIndex;return this._storeGPUActionsIndex=e+1,e}runUnitIfNeeded(e){var t=!1;return this._storeUnits.forEach((e=>{const n=e.current;(null==n?void 0:n._ctx.runUnitIfNeeded(n))&&(t=!0)})),!(!this._needsUnitReRun&&!t||(this._storeIndex=0,this._storeUnitsIndex=0,this._storeGPUActionsIndex=0,this._needsUnitReRun=!1,Object.assign(e,this._unitFn(this)),0))}runGPUActionsIfNeeded(e){this._storeUnits.forEach((t=>{const n=t.current;null==n||n._ctx.runGPUActionsIfNeeded(e)})),this.commandEncoder=e,this._storeGPUActions.forEach((([e,t,n],r)=>{n&&(e(this),this._storeGPUActions[r][2]=!1)})),this.commandEncoder=void 0}_useProp(e){const n=this._nextStoreIndex(),r=this._store[n];if(r)return r;const o=new t("function"==typeof e?e():e,this);return this._store[n]=o,o}_useUnitProp(e){const n=this._nextStoreUnitsIndex(),r=this._storeUnits[n];if(r)return r;const o=new t("function"==typeof e?e():e,this);return this._storeUnits[n]=o,o}_useGPUResource(e,t){const n=this._nextStoreIndex(),r=this._store[n];if(!r){const r=e(this);return this._store[n]=[r,t],r}if(t.every(((e,t)=>e===r[1][t])))return r[0];const o=e(this),i=r[0];return r[0]=o,r[1]=t,i&&"function"==typeof i.destroy&&i.destroy(),o}_useGPUAction(e,t){const n=this._nextStoreGPUActionsIndex(),r=this._storeGPUActions[n];r?t.every(((e,t)=>e===r[1][t]))||(r[0]=e,r[1]=t,r[2]=!0):this._storeGPUActions[n]=[e,t,!0]}_useEffect(e,t){const n=this._nextStoreIndex(),r=this._store[n];if(r)t.every(((e,t)=>e===r[1][t]))||(r[0]&&r[0](),r[0]=e({}),r[1]=t);else{const r=e({});this._store[n]=[r,t]}}}class r{constructor(e){this._renders=[],this._canvasContext=e}addRender(e){this._renders.includes(e)||this._renders.push(e)}outputFrame(e){const t=this._canvasContext.getCurrentTexture();this._renders.forEach((n=>{n.renderTarget.set(t),n.runFrame(e)}))}}var o=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{u(r.next(e))}catch(e){i(e)}}function c(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,c)}u((r=r.apply(e,t||[])).next())}))};function i(){var e,t;const n=null===(t=null===(e=navigator.gpu)||void 0===e?void 0:e.getPreferredCanvasFormat)||void 0===t?void 0:t.bind(navigator.gpu);return n?n():"rgba8unorm"}const s="@stage(vertex)\nfn vertexRenderColoredTriangle(\n  @builtin(vertex_index) index: u32\n) ->\n  @builtin(position) vec4<f32>\n{\n  let triangle = array<vec2<f32>, 3>(\n    vec2<f32>(0.0, 0.433),\n    vec2<f32>(-0.5, -0.433),\n    vec2<f32>(0.5, -0.433),\n  );\n\n  return vec4<f32>(triangle[index], 0.0, 1.0);\n}\n\n@stage(fragment)\nfn fragmentRenderColoredTriangle(\n  @builtin(position) pos_in: vec4<f32>\n) ->\n  @location(0) vec4<f32>\n{\n  return vec4<f32>(\n    pos_in.x * 0.003,\n    pos_in.y * 0.003,\n    1.0 - (pos_in.y * 0.003),\n    1.0,\n  );\n}\n";var c;return c=function(e){const t=function(e){return e._useProp(void 0)}(e),n=function(e,t,n){return e._useGPUResource((e=>e.device.createRenderPipeline({vertex:{module:e.device.createShaderModule({code:s}),entryPoint:"vertexRenderColoredTriangle"},fragment:{module:e.device.createShaderModule({code:s}),entryPoint:"fragmentRenderColoredTriangle",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list"},layout:void 0})),[])}(e);return function(e,r,o){e._useGPUAction((e=>{if(!t.current)return;const r=e.commandEncoder.beginRenderPass({colorAttachments:[{view:t.current.createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]});r.setPipeline(n),r.draw(3,1,0,0),r.end()}),o)}(e,0,[t.current]),{renderTarget:t}},function(e){(()=>o(this,void 0,void 0,(function*(){const e=yield function(e="high-performance"){return o(this,void 0,void 0,(function*(){if(!navigator.gpu)throw new Error("Your browser doesn't have WebGPU enabled!");const t=yield navigator.gpu.requestAdapter({powerPreference:e});if(!t)throw new Error("Failed to get the GPU adapter!");return t.requestDevice()}))}(),t=yield function(e,t){return o(this,void 0,void 0,(function*(){const n=e.getContext("webgpu");if(!n)throw new Error("Failed to get a WebGPU canvas context!");return n.configure({device:t,format:i(),alphaMode:"opaque"}),n}))}(function(){const e=document.querySelector("canvas.main");if(!e)throw new Error("The main canvas wasn't found in the HTML!");return e}(),e),s=((e,t)=>{const o=function(e,t){const r=new n(t,e),o=Object.assign(Object.assign({},t(r)),{_ctx:r});return o.runFrame=e=>function(e,t){const n=e._ctx;n.runUnitIfNeeded(e),n.runGPUActionsIfNeeded(t)}(o,e),o}(e,c),i=new r(t);return i.addRender(o),function(e){i.outputFrame(e)}})(e,t);requestAnimationFrame((function t(){!function(e,t){const n=e.createCommandEncoder();t(n),e.queue.submit([n.finish()])}(e,s),requestAnimationFrame(t)}))})))().catch((e=>{document.querySelector("body").innerHTML=e,console.error(e)}))}(),e})()));
//# sourceMappingURL=demo1.js.map